package com.zmen.backend.repository;

import com.zmen.backend.entity.ChiTietGioHang;
import com.zmen.backend.entity.GioHang;
import com.zmen.backend.entity.Product;
import com.zmen.backend.entity.BienTheSanPham;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface ChiTietGioHangRepository extends JpaRepository<ChiTietGioHang, Long> {
    
    List<ChiTietGioHang> findByGioHang(GioHang gioHang);
    
    List<ChiTietGioHang> findByGioHangId(Long gioHangId);
    
    Optional<ChiTietGioHang> findByGioHangAndSanPhamAndBienTheSanPham(GioHang gioHang, Product sanPham, BienTheSanPham bienTheSanPham);
    
    Optional<ChiTietGioHang> findByGioHangAndSanPhamAndBienTheSanPhamIsNull(GioHang gioHang, Product sanPham);
    
    @Query("SELECT c FROM ChiTietGioHang c WHERE c.gioHang = :gioHang AND c.sanPham = :sanPham")
    List<ChiTietGioHang> findByGioHangAndSanPham(@Param("gioHang") GioHang gioHang, @Param("sanPham") Product sanPham);
    
    @Query("SELECT SUM(c.soLuong) FROM ChiTietGioHang c WHERE c.gioHang = :gioHang")
    Integer sumQuantityByGioHang(@Param("gioHang") GioHang gioHang);
    
    @Query("SELECT COUNT(c) FROM ChiTietGioHang c WHERE c.gioHang = :gioHang")
    long countByGioHang(@Param("gioHang") GioHang gioHang);
    
    void deleteByGioHang(GioHang gioHang);
}

